@page
@model GamesWebsite.Pages.GameDetailsModel
@{
}
<div class="game-details">
    <div class="row">
        <div class="col-lg-12">
            <h2>@Model.game.name Details</h2>
        </div>
        <div class="col-lg-12">
            <div class="content">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="left-info">
                            <div class="left">
                                <h3>Name:</h3>
                                <h4>@Model.game.name</h4>
                            </div>
                            <ul class="no-bullets">
                                <li><i class="fa fa-star">Rating:</i> @Math.Round(@Model.game.rating, 2)</li>
                                <li><i class="fa fa-download">Visitors:</i> @Model.game.numberOfVisitors</li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="right-info">
                            @if (Model.game.gameType == "video")
                            {
                                <div class="left">
                                    <h3>Genres:</h3>
                                    <ul>
                                        @foreach (string genre in Model.genres)
                                        {
                                            <li>@genre</li>
                                        }
                                    </ul>
                                </div>
                                <div class="right">
                                    <h3>Platforms:</h3>
                                    <ul>
                                        @foreach (string platform in Model.platforms)
                                        {
                                            <li>@platform</li>
                                        }
                                    </ul>
                                </div>
                            }
                            else
                            {
                                <div class="middle">
                                    <h3>Types:</h3>
                                    <ul>
                                        @foreach (string type in Model.types)
                                        {
                                            <li>@type</li>
                                        }
                                    </ul>
                                </div>
                            }
                        </div>
                    </div>
                    <div class="col-lg-12">
                        <h3>Description:</h3>
                        <p class="description">@Model.game.description</p>
                    </div>
                    <h2 id="review-title">Reviews:</h2>
                    <div class="reviews container row">
                        @foreach (var review in Model.reviews)
                        {
                            <div class="review col">
                                <p>
                                    Posted by:
                                    <img src="@(string.IsNullOrEmpty(Model.reviews_users.FirstOrDefault(u=>u.username == review.Username)?.imageUrl) ? "/images/Profile-pic.png" : Model.reviews_users.FirstOrDefault(u=>u.username == review.Username).imageUrl)" alt="Avatar" class="avatar" width="30" style="border-radius: 50%;">
                                    @review.Username
                                </p>
                                <hr>
                                <p>Rating: @Math.Round(review.Rating, 2)</p>
                                <hr>
                                <p>Description: @review.Description</p>
                                <hr>
                                <p>
                                    Date: @review.DateOfPosting.ToString("dd MM yyyy")
                                    <div class="text-right review-controls">
                                        @if (User.Identity.IsAuthenticated && User.Identity.Name == review.Username)
                                        {

                                            <div class="left-buttons">
                                                <button type="button" class="btn btn-primary" onclick="toggleEditForm(@review.ReviewId)">Edit</button>
                                                <button type="button" class="btn btn-danger" onclick="toggleDeleteConfirm(@review.ReviewId)">Delete</button>
                                            </div>

                                        }
                                        @if (review.Updated)
                                        {
                                            <p class="review-updated">Updated</p>
                                        }
                                    </div>

                                    <div id="editForm-@review.ReviewId" class="edit-form" style="display: none;">
                                        <form method="post" asp-page-handler="UpdateReview">
                                            <input type="hidden" name="reviewId" value="@review.ReviewId">
                                            <input type="hidden" name="gameName" value="@Model.game.name">
                                            <div>
                                                <label for="rating">Edit Rating:</label>
                                                <select id="rating" name="rating" required>
                                                    <option value="" disabled selected>Select rating</option>
                                                    <option value="5">5 - Excellent</option>
                                                    <option value="4">4 - Very Good</option>
                                                    <option value="3">3 - Good</option>
                                                    <option value="2">2 - Fair</option>
                                                    <option value="1">1 - Poor</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label for="description">Edit Description:</label>
                                                <textarea id="description" name="description" rows="4" cols="50" required>@review.Description</textarea>
                                                <p id="wordCountMessage" style="color: red;"></p>
                                            </div>

                                            <button type="submit" class="btn btn-success">Save Changes</button>
                                            <button type="button" class="btn btn-secondary" onclick="toggleEditForm(@review.ReviewId)">Cancel</button>
                                        </form>
                                    </div>


                                    <div id="deleteConfirm-@review.ReviewId" class="delete-confirmation" style="display: none;">
                                        <p>Are you sure you want to delete this review?</p>
                                        <form method="post" asp-page-handler="DeleteReview">
                                            <input type="hidden" name="reviewId" value="@review.ReviewId">
                                            <input type="hidden" name="gameName" value="@Model.game.name">
                                            <button type="submit" class="btn btn-danger">Yes</button>
                                            <button type="button" class="btn btn-secondary" onclick="toggleDeleteConfirm(@review.ReviewId)">No</button>
                                        </form>
                                    </div>

                            </div>
                        }

                        @if (User.Identity.IsAuthenticated && Model.canAddReview == true)
                        {
                            <form method="post" asp-page-handler="AddReview">
                                <div class="review col">
                                    <input type="hidden" name="gameName" value="@Model.game.name">
                                    <p>Add Review:</p>
                                    <div>
                                        <label for="rating">Rating:</label>
                                        <select id="rating" name="rating" required>
                                            <option value="" disabled selected>Select rating</option>
                                            <option value="5">5 - Excellent</option>
                                            <option value="4">4 - Very Good</option>
                                            <option value="3">3 - Good</option>
                                            <option value="2">2 - Fair</option>
                                            <option value="1">1 - Poor</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="description">Description:</label>
                                        <textarea id="description" placeholder="Enter your description" name="description" required></textarea>
                                        <p id="wordCountMessage" style="color: red;"></p>
                                    </div>
                                    <button type="submit">Submit</button>
                                </div>
                            </form>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
    @section Scripts {
        <script>
            function toggleEditForm(reviewId) {
                var form = document.getElementById('editForm-' + reviewId);
                var confirmBox = document.getElementById('deleteConfirm-' + reviewId);

                if (confirmBox.style.display === 'block') {
                    confirmBox.style.display = 'none';
                }

                form.style.display = form.style.display === 'none' ? 'block' : 'none';
            }

            function toggleDeleteConfirm(reviewId) {
                var confirmBox = document.getElementById('deleteConfirm-' + reviewId);
                var form = document.getElementById('editForm-' + reviewId);

                if (form.style.display === 'block') {
                    form.style.display = 'none';
                }

                confirmBox.style.display = confirmBox.style.display === 'none' ? 'block' : 'none';
            }

            document.addEventListener("DOMContentLoaded", function () {
                var avatars = document.querySelectorAll('.avatar');
                avatars.forEach(function (avatar) {
                    avatar.addEventListener('mouseover', function () {
                        avatar.style.transform = 'scale(10)';
                    });
                    avatar.addEventListener('mouseout', function () {
                        avatar.style.transform = 'scale(1)';
                    });
                });
            });
        </script>
    }
