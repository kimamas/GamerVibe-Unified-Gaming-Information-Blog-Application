@page
@model BlogsModel
@using BLLClassLibrary.Managers;
@{
    ViewData["Title"] = "Blogs";
}

<div class="blogs-container">
    <div class="filter-section">
        <h4 class="filter-title">Filter Blogs</h4>
        <form method="post" asp-page-handler="FilterBlogs">
        <div class="filter-options">
            <label for="filterCategory" class="filter-label">Filter by Category:</label>
            <select id="filterCategory" name="filterCategory" class="filter-select">
                <option value="All">All</option>
                @foreach (var category in Model.Categories)
                {
                        <option value="@category" selected="@(Model.IsSelected(@category))">@category</option>
                }
            </select>
            <label for="filterName" class="filter-label">Filter by Name:</label>
            <input type="text" id="filterName" name="filterName" class="filter-input" placeholder="Search by name">
        </div>
        <button type="submit" class="btn btn-primary filter-apply-button">Apply Filters</button>
        </form>
    </div>

    <div class="add-blog-section">
        <h4 class="add-blog-title">Add New Blog</h4>
        <button id="addBlogButton" class="btn btn-success" onclick="toggleAddBlogForm()">Add Blog</button>
        <div id="addBlogForm" style="display:none;">
            <form method="post" asp-page-handler="AddBlog">
                <input type="text" name="NewBlogName" placeholder="Blog Name" required />

                <select id="BlogGameNames" name="GameName" class="filter-select" required>
                    <option value="" disabled selected>Select Game</option>
                    @foreach (var game in Model.GameNames)
                    {
                        <option value="@game">@game</option>
                    }
                </select>

                <select id="BlogCategory" name="Category" class="filter-select" required>
                    <option value="" disabled selected>Select Category</option>
                    @foreach (var category in Model.Categories)
                    {
                        <option value="@category">@category</option>
                    }
                </select>
                <textarea class="description-blogs" name="NewBlogDescription" placeholder="Blog Description" required></textarea>
                <button type="submit" class="btn btn-success">Submit</button>
                <button type="button" class="btn btn-secondary" onclick="toggleAddBlogForm()">Cancel</button>
            </form>
        </div>
    </div>

    <div class="blog-list">
        @foreach (var blog in Model.Blogs)
        {
            var hasLiked = Model.UserLikes.Contains(blog.BlogId);

            <div class="blog-item">
                <p class="blog-meta">@blog.UserUsername - @Model.GetTimeAgo(blog.Created)</p>
                <h4 class="blog-item-title">@blog.Name</h4>
                
                <p class="blog-item-description">@blog.Description</p>
                <p>Game: @blog.GameName</p>
                <div class="blog-actions">
                    <form method="post" asp-page-handler="ToggleLikeBlog" asp-route-blogId="@blog.BlogId" class="inline-form">
                        <button type="submit" class="btn blog-like-button">
                            <i class="fa fa-heart @(hasLiked ? "liked" : "")"></i>
                            <span class="like-count">@Model.BlogLikes[blog.BlogId]</span>
                        </button>
                    </form>
                    <a asp-page="BlogDetails" asp-route-blogId="@blog.BlogId" class="btn btn-primary blog-read-more-button">Read More</a>
                    @if (blog.UserUsername == User.Identity.Name)
                    {
                        <button id="deleteBlogButton-@blog.BlogId" class="btn btn-danger" onclick="toggleBlogDelete(@blog.BlogId)">Delete</button>

                        <div id="deleteBlogForm-@blog.BlogId" class="deleteForm" style="display:none;">
                            <p>Are you sure you want to delete this blog?</p>
                            <form method="post" asp-page-handler="DeleteBlog" asp-route-blogId="@blog.BlogId">
                                <button type="submit" class="btn btn-danger">Yes</button>
                                <button type="button" class="btn btn-secondary" onclick="toggleBlogDelete(@blog.BlogId)">No</button>
                            </form>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
    <div class="pagination">
        @if (Model.PageNumber > 1)
        {
            <a asp-page="./Blogs" asp-route-pageNumber="@(Model.PageNumber - 1)" class="btn btn-light">Previous</a>
        }
        <span>Page @Model.PageNumber of @Model.TotalPages</span>
        @if (Model.PageNumber < Model.TotalPages)
        {
            <a asp-page="./Blogs" asp-route-pageNumber="@(Model.PageNumber + 1)" class="btn btn-light">Next</a>
        }
    </div>
</div>

@section Scripts {
    <script src="~/js/site.js"></script>
}
